@page "/calculations"
@rendermode InteractiveServer

<PageTitle>Вычисления</PageTitle>

<h3>Вычисления</h3>
<div class="Input">
    <p>Количество хищников:</p> <input class="form-control" type="number" min="1" step="1" @bind="P_init" />
    <p>Количество жертв:</p> <input class="form-control" type="number" min="2" step="1" @bind="V_init" />
    <p>Время наблюдения:</p> <input class="form-control" type="number" step="0.01" @bind="Time" />
    <p>Шаг интегрирования:</p><input class="form-control" type="number" min="0.01" step="0.01" @bind="H_step" />
    <p>Вероятность рождаемости жертв:</p> <input class ="form-control" type="number" min="0" max="1" step="0.01" @bind="a" />
    <p>Вероятность смертности жертв при встрече с хищником:</p> <input class="form-control" type="number" min="0" max="1" step="0.01" @bind="b" />
    <p>Вероятность убыли хищников при нехватке еды:</p> <input class="form-control" type="number" step="0.01" min="0" max="1" @bind="c" />
    <p>Вероятность достаточности еды для размножения хищников:</p><input class="form-control" type="number" step="0.01" min="0" max="1" @bind="d" />
    <p></p>
    <button class="btn btn-primary" @onclick="Calculate">Вычислить</button>
</div>
 
@if (LV_Results == null)
{
    <p><em>Здесь должны быть результаты расчётов</em></p>
}
else{
     <div><LineChart @ref="lineChart" /></div>
<table class="table">
    <thead>
        <tr>
            <th>Время</th>
            <th>Кол-во хищников</th>
            <th>Кол-во жертв</th>
        </tr>
    </thead>
    <tbody>
        @* @foreach (var person in people)
        {
            <tr>
                <td>@person.Name</td>
                <td>@person.Age</td>
            </tr>
        } *@
            @foreach(var LV in LV_Results)
            {
                <tr>
                    <td>@LV.Time</td>
                    <td>@LV.P</td>
                    <td>@LV.V</td>
                </tr>
            }
        </tbody>
</table>

}



@code {
    private LineChart lineChart = default!;
    private double P_init=10;
    private double V_init=80;
    private double Time=100;
    private double H_step=0.1;

    private double a=0.5;
    private double b=0.02;
    private double c=0.4;
    private double d=0.1;
    //List<double>
  //  private LineChart lineChart = default!;//График
    public class Lotki_Volterra
    {
    
        List<double> Calc_P= new List<double>();
        List<double> Calc_V = new List<double>();
        List<double> Times = new List<double>();
        double a;
        double b;
        double c;
        double d;

        double End_Time;

        public Lotki_Volterra(double a, double b, double c, double d, double P, double V, double T)
        {
            this.a = a; this.d = d; this.c = c; this.b = b; Calc_P.Add(P); Calc_V.Add(V); End_Time = T;
        }

        private double dV_dt(double P, double V) => (a - b * P) * V;
        private double dP_dt(double P, double V) => (-c + d * V) * P;
        private void RungeKutta4(double P, double V, double h)
        {

              double p1 = dP_dt(P, V);
            double q1 = dV_dt(P, V);

            double p2 = dP_dt(P + 0.5 * h * p1, V + 0.5 * h * q1);
            double q2 = dV_dt(P + 0.5 * h * p1, V + 0.5 * h * q1);

            double p3 = dP_dt(P + 0.5 * h * p2, V + 0.5 * h * q2);
            double q3 = dV_dt(P + 0.5 * h * p2, V + 0.5 * h * q2);

            double p4 = dP_dt(P + h * p3, V + h * q3);
            double q4 = dV_dt(P + h * p3, V + h * q3);

            double Pnext = P + (h / 6.0) * (p1 + 2 * p2 + 2 * p3 + p4);
            double Vnext = V + (h / 6.0) * (q1 + 2 * q2 + 2 * q3 + q4);

            if (Pnext < 0 && Pnext > -1e-12) Pnext = 0.0;
            if (Vnext < 0 && Vnext > -1e-12) Vnext = 0.0;
            Calc_P.Add(Pnext);
            Calc_V.Add(Vnext);
        }

        public void Calculate(double H)
        {
            double Current_time = 0;
            while (Current_time <= End_Time)
            {
                RungeKutta4(Calc_P.Last(), Calc_V.Last(), H);
                Times.Add(Current_time);
                Current_time += H;
            }
        }
        public List<LV_Result> Pack_into_table()
        {
            List<LV_Result> LV_Results = new List<LV_Result>();

            for(int i = 0; i < Times.Count; i++)
            {
                LV_Result LV = new LV_Result() { Time = Times[i], P = Calc_P[i], V = Calc_V[i] };
                LV_Results.Add(LV);
            }

            return LV_Results;
        }

    }

    public class LV_Result//Хранение результатов
    {
        public double Time;
        public double P;
        public double V;
    }
    private List<LV_Result> LV_Results = null;
    async Task Calculate()
    {
        Lotki_Volterra LV_Model = new Lotki_Volterra(a, b, c, d, P_init, V_init, Time);
        LV_Model.Calculate(H_step);
        LV_Results = LV_Model.Pack_into_table();
         if(LV_Results.Count()!=0)
             await RenderPlotAsync();
    }

    private async Task RenderPlotAsync()
{
    if (LV_Results == null || LV_Results.Count == 0)
        return;

    // Если lineChart ещё null (компонент не отрисовался), коротко подождём и повторим проверку
    int waitAttempts = 5;
    while (lineChart == null && waitAttempts-- > 0)
    {
        // даём рендеру завершиться
        await Task.Yield();
        // маленькая пауза для серверного рендера (опционально)
        await Task.Delay(20);
    }

    if (lineChart == null)
    {
        Console.Error.WriteLine("lineChart is null — не удалось получить @ref для LineChart.");
        return;
    }

    var Axis_X = new List<string>(LV_Results.Count);
    var P_Line = new List<double?>(LV_Results.Count);
    var V_Line = new List<double?>(LV_Results.Count);

    foreach (var LV in LV_Results)
    {
        Axis_X.Add(LV.Time.ToString("G"));
        P_Line.Add(LV.P);
        V_Line.Add(LV.V);
    }

    var data = new ChartData
    {
        Labels = Axis_X,
        Datasets = new List<IChartDataset>
        {
            new LineChartDataset { Label = "Хищники", Data = P_Line, BackgroundColor = "rgb(88, 80, 141)", BorderColor = "rgb(88, 80, 141)", BorderWidth = 2 },
            new LineChartDataset { Label = "Жертвы",  Data = V_Line, BackgroundColor = "rgb(255, 166, 0)", BorderColor = "rgb(255, 166, 0)", BorderWidth = 2 }
        }
    };



    
    var options = new LineChartOptions
    {
        Responsive = true
        
    };
    options.Scales.X!.Title = new ChartAxesTitle { Text = "Время", Display = true };
    options.Scales.Y!.Title = new ChartAxesTitle { Text = "Популяция", Display = true };

    await lineChart.InitializeAsync(data,options,null);
}


}
